<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport"
        content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <title>1H 文件共享</title>
    <style>
        .action-btn {
            background: #535a64;
            color: #f2f2f2;
            margin: 5px;
            padding: 10px 20px 10px 20px;
            font-size: 20px;
            font-family: 微软雅黑, 宋体, Arial, Helvetica, Verdana, sans-serif;
            font-weight: bold;
            border-radius: 5px;

            -webkit-transition: all linear 0.20s;
            -moz-transition: all linear 0.20s;
            transition: all linear 0.20s;
            cursor: pointer;
        }

        .action-btn:hover {
            background: #c14c4c;
        }

        #key {
            height: 82px;
            width: 76%;
            font-size: xx-large;
            border: 0;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            font-family: math;
            letter-spacing: 10px;
            font-weight: bold;
            -webkit-transition: all linear 0.08s;
            -moz-transition: all linear 0.08s;
            transition: all linear 0.08s;
            box-shadow: 0 2px 4px 0 rgb(203 25 25 / 20%), 0 1px 5px 0 rgb(0 0 0 / 19%);
            outline: none;
            box-sizing: border-box;
            caret-color: #00000054;
        }

        #key:focus,
        #key:hover {
            box-shadow: 0 8px 16px 0 rgb(203 25 25 / 20%), 0 6px 20px 0 rgb(0 0 0 / 19%);
        }
    </style>
    <script>

    </script>
</head>

<body style="background:#f7fafc;overflow-x: hidden;">
    <div id="pp" class="app" style="text-align: center;display: none;">
        <h1 style="margin-top: 100px;letter-spacing: 10px;">1H文件共享</h1>
        <div style="margin-top: 50px;">
            <input id="key" placeholder="提取码" onkeydown="inputKeyDown(event)" /> <br><br><br>
            <input type="file" value="" id="fileInput" name="files" onchange="fileSelected()"
                style="opacity: 0;height: 0;" />
            <!-- 按钮 -->
            <div style="margin:0 auto;">
                <input class="action-btn" id="download" type="button" value="提 取" onclick="download()" />
                <input class="action-btn" id="upload" type="button" value="上 传" onclick="uploadFile()" />
                <input class="action-btn" id="clear" type="button" value="清 空" onclick="document.getElementById('key').value='';
                    document.getElementById('msg').innerHTML ='';resetProgress(); document.getElementById('fileName').innerHTML = '';
                    document.getElementById('fileSize').innerHTML = '';
                    document.getElementById('fileInput').value = '';
                    globalFile=null;
                    document.getElementById('fileType').innerHTML = '';" />
            </div>
            <!-- 提示条 -->
            <div style="margin:0 auto;text-align: center;font-size: large;font-weight: bold;">
                <br>
                <div id="msg">⁣⁣⁣⁣　</div><br>
            </div>
            <!-- 上传的文件信息 -->
            <div style="margin: 0 auto;text-align: left;width:80%;font-size: large;font-weight: bold;">
                <div id="fileName"></div>
                <div id="fileSize"></div>
                <div id="fileType"></div>
            </div>

            <div id="upload-parent" style="display: none;margin-top: 15px;">
                <div style="width:80%;height:20px;border:2px solid #d3a7a7;border-radius: 5px;margin: 0 auto;">
                    <div id="progress" style="background:#CCCC66;height:20px;width:0%;border-radius: 0px 5px 5px 0px;">
                    </div><br>
                    <div id="percentNumber"></div>
                </div>
                <br><br>
            </div>
        </div>
    </div>
    <div id="dd" style="display: none;float: right;margin: 10px;">
        <label style="font-size: larger;font-weight: bold;">微信浏览器不好用, 用自带浏览器打开 ↑</label>
    </div>
    <script type="text/javascript">
        let globalFile = null;
        document.getElementById(isWxB() ? "dd" : "pp").style.display = "block";

        document.getElementById("key").addEventListener("dragenter", (e) => {
            e.srcElement.style.caretColor = "transparent";
            e.preventDefault();
            e.srcElement.setAttribute("placeholder", "松开文件上传");
            e.srcElement.style.border = "dashed 5px #d19898";
        })
        document.getElementById("key").addEventListener("dragleave", (e) => {
            e.preventDefault();
            e.srcElement.setAttribute("placeholder", "提取码");
            e.srcElement.style.border = "";
            e.srcElement.style.caretColor = "#00000054";
        });
        document.getElementById("key").addEventListener("drop", (e) => {
            e.preventDefault();
            e.srcElement.setAttribute("placeholder", "提取码");
            e.srcElement.style.border = "";
            globalFile = e.dataTransfer.files[0];
            e.srcElement.style.caretColor = "#00000054";
            fileSelected(true);
        });
        let tmpfServerPath = "https://124.223.78.28:8766/tmp-file";
        // let tmpfServerPath = "https://127.0.0.1:8766/tmp-file";
        let fileReqName = "file";
        let keyReqName = "key";
        let isUploading = false;
        let thisXhr = null;

        function inputKeyDown(event) {
            let evt = window.event || e;
            if (evt.keyCode == 13 && !isUploading) {
                let file = globalFile;
                if (file) {
                    // 上传
                    document.getElementById("upload").click();
                } else {
                    // 下载
                    document.getElementById("download").click();
                }
                if (document.getElementById("key").value.trim() != "") {
                    document.activeElement.blur();
                }

            }
        }

        function resetFile() {
            globalFile = null;
        }

        function setUploading(loading) {
            let btn = document.getElementById("upload");
            if (loading) {
                btn.value = "取 消 上 传";
                document.getElementById("upload-parent").style.display = "block";
            } else {
                btn.value = "上 传";
                document.getElementById("upload-parent").style.display = "none";
            }
            isUploading = loading;
        }

        function fileSelected(isDrop) {
            let file = null;
            if (!isDrop) {
                file = document.getElementById("fileInput").files[0];
                globalFile = file;
            } else {
                file = globalFile;
            }
            if (file) {
                let fileSize = 0;
                if (file.size > 1024 * 1024)
                    fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
                else
                    fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';
                document.getElementById('fileName').innerHTML = '文件名: ' + file.name;
                document.getElementById('fileSize').innerHTML = '大小: ' + fileSize;
                document.getElementById('fileType').innerHTML = file.type ? ('类型: ' + file.type) : "";
            }
        }

        function resetProgress() {
            document.getElementById('percentNumber').innerHTML = '';
            document.getElementById("progress").style.width = "0%";
        }

        function uploadFile() {
            showMessage("　");
            resetProgress();
            if (document.getElementById('fileInput').files.length == 0 && globalFile == null) {
                document.getElementById("fileInput").click();
                return false;
            }
            if (isUploading) {
                thisXhr.abort();
                setUploading(false);
            } else {
                let key = document.getElementById('key').value;
                if (!checkKey(key)) {
                    return false;
                }
                searchKey(key, hasKey => {
                    if (hasKey) {
                        showMessage(`提取码"${key}"被占用了,换一个试试`);
                        allBtnEnable();
                    } else {
                        let file = globalFile;
                        if (file.size > 1024 * 1024 * 1000) {
                            showMessage("文件过大");
                            allBtnEnable()
                            return false;
                        }
                        let fd = new FormData();
                        fd.append(fileReqName, file);
                        fd.append(keyReqName, document.getElementById('key').value);
                        let xhr = new XMLHttpRequest();
                        xhr.upload.addEventListener("progress", uploadProgress, false);
                        xhr.addEventListener("load", uploadComplete, false);
                        xhr.addEventListener("error", uploadFailed, false);
                        xhr.addEventListener("abort", uploadCanceled, false);
                        xhr.open("POST", `${tmpfServerPath}/upload`);
                        showMessage("上传中,请不要离开此页面...",true);
                        // document.getElementById("key").setAttribute("readonly",true);
                        editBtnDisabled("clear", true);
                        editBtnDisabled("download", true);
                        setUploading(true);
                        xhr.send(fd);
                        thisXhr = xhr;
                    }
                });

            }

        }

        function uploadProgress(evt) {
            if (evt.lengthComputable) {
                let percentComplete = Math.round(evt.loaded * 100 / evt.total);
                document.getElementById('percentNumber').innerHTML = percentComplete + '%';
                let jindutiao = document.getElementById("progress");
                jindutiao.style.width = percentComplete + "%";
                if (percentComplete == 100) {
                    showMessage("处理中...", true);
                }
            } else {
                document.getElementById('percentNumber').innerHTML = '不支持进度计算';
            }
        }

        function checkKey(key) {
            let res = key.match("^[a-zA-Z0-9_\u4e00-\u8fa5]+$");
            if (!res) {
                showMessage("提取码 使用用汉字,数字,字母,下划线");
            }
            return res;
        }

        function uploadComplete(evt) {
            let res = JSON.parse(evt.currentTarget.response);
            if (res.status == 200) {
                showMessage("上传成功!有效期至 " + new Date(new Date().getTime() + 1000 * 60 * 60).toLocaleString(), true);
            } else {
                showMessage(res.msg);
            }
            allBtnEnable();
        }

        function uploadFailed(evt) {
            showMessage("上传错误", true);
            allBtnEnable();
        }

        function uploadCanceled(evt) {
            showMessage("取消上传");
            allBtnEnable();
        }
        // 提取
        function download() {
            let key = document.getElementById('key').value;
            if (!checkKey(key)) {
                return false;
            }
            globalFile = null;
            resetProgress();
            editBtnDisabled("clear", true);
            editBtnDisabled("upload", true);
            document.getElementById('fileName').innerHTML = "";
            document.getElementById('fileSize').innerHTML = "";
            document.getElementById('fileType').innerHTML = "";
            document.getElementById('fileInput').value = '';
            searchKey(key, hasKey => {
                if (hasKey) {
                    showMessage(`已开始下载...`, true);
                    window.location.href = `${tmpfServerPath}/file/${key}`;
                    allBtnEnable();
                } else {
                    showMessage(`提取码: "${key}"不存在`);
                    allBtnEnable();
                }
            });
        }

        function searchKey(key, cb) {
            if (key == null || key.trim() == "") {
                showMessage("老铁, 先填 提取码");
                allBtnEnable();
                return false;
            }
            showMessage("查询中...", true);
            getJsonGet(`${tmpfServerPath}/key/${key}`, res => {
                if (res.status == 200) {
                    cb(res.data);
                } else {
                    showMessage(res.msg);
                    allBtnEnable();
                }
            }, error => {
                // if (error.toString() == "TypeError: Failed to fetch") {
                    alert("请允许弹出窗口并继续访问");
                    window.open(`${tmpfServerPath}/trust`);
                // } else {
                //     showMessage(error);
                //     allBtnEnable();
                // }
            })
        }

        function showMessage(msg, fix) {
            let now = new Date().toLocaleTimeString();
            document.getElementById("msg").innerHTML = msg;
            if (!fix) {
                setTimeout(() => {
                    if (document.getElementById("msg").innerHTML == msg) {
                        document.getElementById("msg").innerHTML = "⁣⁣⁣⁣　";
                    }
                }, 3000);
            }

        }

        function editBtnDisabled(btnId, disabled) {
            document.getElementById(btnId).disabled = disabled;
        }

        function allBtnEnable() {
            editBtnDisabled("clear", false);
            editBtnDisabled("upload", false);
            editBtnDisabled("download", false);
            // document.getElementById("key").value = "";
            setUploading(false);
        }
        let getFetch = (url, method, okCallback, errorCallback, data, headers) => {
            let option = {
                method: method,
                credentials: 'include'
            };
            if (data) {
                option.body = data;
            }
            if (headers) {
                option.headers = headers;
            }
            fetch(url, option)
                .then(response => response.json())
                .then(response => {
                    if (okCallback) okCallback(response);
                })
                .catch(error => {
                    if (errorCallback) errorCallback(error);
                });
        }
        let getJsonPost = (url, okCallback, errorCallback, data) => {
            getFetch(url, "POST", okCallback, errorCallback, JSON.stringify(data), util.fetchConfig
                .contentTypeJson);
        }
        let getJsonGet = (url, okCallback, errorCallback) => {
            getFetch(url, "GET", okCallback, errorCallback, null, null);
        }
        let fetchConfig = {
            contentTypeJson: {
                'content-type': 'application/json'
            },
            contentTypeText: {
                'content-type': 'application/txt'
            }
        };

        function isWxB() {
            var ua = navigator.userAgent.toLowerCase();
            return ua.indexOf('micromessenger') != -1;
        }
    </script>
    <!-- <footer style="text-align: center;width: 100%;position: absolute;bottom: 10px;">
        <label style="font-size: larger;font-weight: bold;font-family: fantasy;letter-spacing: 5px;cursor: pointer;"
            onclick="window.open('https://github.com/Zsk-d')">Zsk-d</label>
    </footer> -->
</body>

</html>
