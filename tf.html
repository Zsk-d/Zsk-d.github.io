<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport"
        content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <title>1H文件共享</title>
</head>

<body>
    <div class="app" style="text-align: center;">
        <h2>1H文件共享</h2>
        <div>
            <label style="font-size: x-large;">KEY: </label><br><input id="key"
                style="height: 40px;width: 70%;font-size: xx-large;border-radius: 5px;padding: 10px;text-align: center;" />
            <br><br>
            <input type="file" value="" id="fileInput" name="files" onchange="fileSelected()" />
            <div style="margin:15px auto;">
                <input id="download" type="button" value="提取" style=" height: 50px;width: 80px;margin:10px"
                    onclick="download()" />
                <input id="upload" type="button" value="上传" style=" height: 50px;width: 80px;margin:10px"
                    onclick="uploadFile()" />
                <input id="clear" type="button" value="清空" style=" height: 50px;width: 80px;margin:10px" onclick="document.getElementById('key').value='';
                    document.getElementById('msg').innerHTML ='';resetProgress(); document.getElementById('fileName').innerHTML = '';
                    document.getElementById('fileSize').innerHTML = '';
                    document.getElementById('fileType').innerHTML = '';" />
            </div>
            <div style="margin:20px;text-align: left;">
                <div id="fileName"></div>
                <div id="fileSize"></div>
                <div id="fileType"></div>
            </div>

            <div id="upload-parent" style="display: none;">
                <div>
                    <label>上传进度:</label>
                </div><br>
                <div style="width:80%;height:25px;border:2px solid #aeaeae;border-radius: 5px;margin: 0 auto;">
                    <div id="progress" style="background:#4cff00;height:25px;width:0%;"></div><br>
                    <div id="percentNumber"></div>
                </div>
                <br><br>
            </div>
            <div style="margin:10px;text-align: left;">
                <div id="msg"></div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        let tmpfServerPath = "http://124.223.78.28:8766/tmp-file";
        // let tmpfServerPath = "http://127.0.0.1:8766/tmp-file";
        let fileReqName = "file";
        let keyReqName = "key";
        let isUploading = false;
        let thisXhr = null;

        function setUploading(loading) {
            let btn = document.getElementById("upload");
            if (loading) {
                btn.value = "取消上传";
                document.getElementById("upload-parent").style.display = "block";
            } else {
                btn.value = "上传";
                document.getElementById("upload-parent").style.display = "none";
            }
            isUploading = loading;
        }
        function fileSelected() {
            let file = document.getElementById('fileInput').files[0];
            if (file) {
                let fileSize = 0;
                if (file.size > 1024 * 1024)
                    fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
                else
                    fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';
                document.getElementById('fileName').innerHTML = '文件名: ' + file.name;
                document.getElementById('fileSize').innerHTML = '大小: ' + fileSize;
                document.getElementById('fileType').innerHTML = '类型: ' + file.type;
            }
        }
        function resetProgress() {
            document.getElementById('percentNumber').innerHTML = '';
            document.getElementById("progress").style.width = "0%";
        }
        function uploadFile() {
            resetProgress();
            if (isUploading) {
                thisXhr.abort();
                setUploading(false);
            } else {
                let key = document.getElementById('key').value;
                searchKey(key, hasKey => {
                    if (hasKey) {
                        showMessage(`KEY: "${key}"已存在`);
                        allBtnEnable();
                    } else {
                        let fd = new FormData();
                        let now = new Date().toLocaleString();
                        if (document.getElementById('fileInput').files.length == 0) {
                            showMessage("未选择文件");
                            allBtnEnable()
                            return false;
                        }
                        let file = document.getElementById('fileInput').files[0];
                        if (file.size > 1024 * 1024 * 200) {
                            showMessage("文件过大");
                            allBtnEnable()
                            return false;
                        }
                        fd.append(fileReqName, file);
                        fd.append(keyReqName, document.getElementById('key').value);
                        let xhr = new XMLHttpRequest();
                        xhr.upload.addEventListener("progress", uploadProgress, false);
                        xhr.addEventListener("load", uploadComplete, false);
                        xhr.addEventListener("error", uploadFailed, false);
                        xhr.addEventListener("abort", uploadCanceled, false);
                        xhr.open("POST", `${tmpfServerPath}/upload`);
                        showMessage("上传中...");
                        editBtnDisabled("clear", true);
                        editBtnDisabled("download", true);
                        setUploading(true);
                        xhr.send(fd);
                        thisXhr = xhr;
                    }
                });

            }

        }

        function uploadProgress(evt) {
            if (evt.lengthComputable) {
                let percentComplete = Math.round(evt.loaded * 100 / evt.total);
                document.getElementById('percentNumber').innerHTML = percentComplete + '%';
                let jindutiao = document.getElementById("progress");
                jindutiao.style.width = percentComplete + "%";
                if(percentComplete == 100){
                    showMessage("处理中...");
                }
            } else {
                document.getElementById('percentNumber').innerHTML = '不支持进度计算';
            }
        }
        function uploadComplete(evt) {
            let res = JSON.parse(evt.currentTarget.response);
            if (res.status == 200) {
                showMessage("上传成功!");
            } else {
                showMessage(res.msg);
            }
            allBtnEnable();
        }
        function uploadFailed(evt) {
            showMessage("上传错误");
            allBtnEnable();
        }
        function uploadCanceled(evt) { showMessage("取消上传"); allBtnEnable(); }
        // 提取
        function download() {
            let key = document.getElementById('key').value;
            resetProgress();
            editBtnDisabled("clear", true);
            editBtnDisabled("upload", true);
            document.getElementById('fileName').innerHTML = "";
            document.getElementById('fileSize').innerHTML = "";
            document.getElementById('fileType').innerHTML = "";
            searchKey(key, hasKey => {
                if (hasKey) {
                    showMessage(`已开始下载...`);
                    window.location.href = `${tmpfServerPath}/file/${key}`;
                    allBtnEnable();
                } else {
                    showMessage(`KEY: "${key}"不存在`);
                    allBtnEnable();
                }
            });
        }
        function searchKey(key, cb) {
            if (key == null || key.trim() == "") {
                showMessage("key不能为空");
                allBtnEnable();
                return false;
            }
            getJsonGet(`${tmpfServerPath}/key/${key}`, res => {
                if (res.status == 200) {
                    cb(res.data);
                } else {
                    showMessage(res.msg);
                    allBtnEnable();
                }
            }, error => {
                showMessage(error);
                allBtnEnable();
            })
        }
        function showMessage(msg) {
            let now = new Date().toLocaleString();
            document.getElementById("msg").innerHTML = now + ": " + msg;
        }

        function editBtnDisabled(btnId, disabled) {
            document.getElementById(btnId).disabled = disabled;
        }

        function allBtnEnable() {
            editBtnDisabled("clear", false);
            editBtnDisabled("upload", false);
            editBtnDisabled("download", false);
            setUploading(false);
        }
        let getFetch = (url, method, okCallback, errorCallback, data, headers) => {
            let option = { method: method, credentials: 'include' };
            if (data) { option.body = data; }
            if (headers) { option.headers = headers; }
            fetch(url, option)
                .then(response => response.json())
                .then(response => {
                    if (okCallback) okCallback(response);
                })
                .catch(error => {
                    if (errorCallback) errorCallback(error);
                });
        }
        let getJsonPost = (url, okCallback, errorCallback, data) => { getFetch(url, "POST", okCallback, errorCallback, JSON.stringify(data), util.fetchConfig.contentTypeJson); }
        let getJsonGet = (url, okCallback, errorCallback) => { getFetch(url, "GET", okCallback, errorCallback, null, null); }
        let fetchConfig = { contentTypeJson: { 'content-type': 'application/json' }, contentTypeText: { 'content-type': 'application/txt' } };
    </script>
</body>

</html>